/**
 * @package WordPress
 * @subpackage AidanAmavi
 * @version 0.3
 *
 * @author Aidan Amavi <mail@aidanamavi.com>
 * @link http://www.aidanamavi.com Author's Web Site
 * @copyright 2012 - 2015, Aidan Amavi
 * @license http://creativecommons.org/licenses/by-sa/4.0/ Attribution-ShareAlike 4.0 International
 */
/*global _paq, alert, siteName, category, userId, nonce*/

jQuery(document).ready( function() {
	// Configurable settings.
	var homepageDiv = 'page_work';
	// Dynamic settings.
	var ajaxurl = window.location.protocol+'//'+window.location.host+'/wp-admin/admin-ajax.php';
	var visiblePage = jQuery('#content_wrapper :visible').attr('id');
	var pageReferrerUrl = document.referrer || document.location.href;
	var isPageLoading = false;
	var isSlideLoading = false;
	var isThumbnailLoading = false;
	var currentProjectType = 'all';

String.prototype.capitalize = function() {
  return this.replace(/(?:^|\s)\S/g, function(a) { return a.toUpperCase(); });
};
function updateVisiblePage() {
		visiblePage = jQuery('#content_wrapper :visible').attr('id');
		// Enables checking for new posts since visiblePage was last viewed.
		areAllPostsLoaded = false;
	}
	function showLoadingAnimation() {
		isPageLoading = true;
		jQuery('#loading_animation').stop().show().animate({'opacity': '.85'},750);
	}
	function hideLoadingAnimation() {
		jQuery('#loading_animation').stop().animate({'opacity': '0'},1000, function(){
			jQuery('#loading_animation').hide();
			isPageLoading = false;
			//updateVisiblePage();
		});
	}
	function addHighlightSlideCursor() {
		jQuery('div.highlight_slides').each( function(){
			var divs = jQuery(this);
			var the_count = divs.children().length;
			if (the_count > 1) {
				divs.children().css('cursor', 'pointer');
			}
		});
	}
	function displayPage(pageDiv, pageUrl, pageContent) {
		jQuery('#'+visiblePage).stop().animate({'opacity':'0'},750, function() {
			jQuery('#'+visiblePage).hide( function() {
				if (pageContent) {
					jQuery('#content_wrapper').css('opacity', '0');
					jQuery('#content_wrapper').append(pageContent);
					jQuery('#content_wrapper').animate({'opacity':'1'},750);
					addHighlightSlideCursor();
				} else {
					jQuery('#'+pageDiv).show().animate({'opacity':'1'},750);
				}
				var pageTitle = jQuery('#'+pageDiv).data('pageTitle');
				updateCategory(pageDiv);
				updateTitle(pageTitle);
				updateUrl(pageUrl);
				updateVisiblePage();
				hideLoadingAnimation();
			});
		});
	}
	function transitionSlide(pageId, oldSlide, newSlide) {
		var newSlideElement = jQuery('div#'+pageId+' .highlight_slides div[data-slide='+newSlide+']');
		var oldSlideElement = jQuery('div#'+pageId+' .highlight_slides div[data-slide='+oldSlide+']');

		// Show next slide, and hide visible slide.
		newSlideElement.stop().css('z-index','10').stop().show().animate({'opacity':'1'},250, function() {
			oldSlideElement.stop().animate({'opacity':'0'},250, function(){
				oldSlideElement.hide();
				newSlideElement.css('z-index','5');
				trackAction(pageId, newSlide);
				isSlideLoading = false;
			});
		});

		var buttonList = jQuery('#'+pageId+' .numbers_wrapper .numbers');
		var newButtonImage = buttonList.children('[data-slide='+newSlide+']').children('img.off');
		var oldButtonImage = buttonList.children('[data-slide='+oldSlide+']').children('img.off');

		// Make the off button visible to turn off highlight.
		oldButtonImage.stop().show().animate({'opacity':'1'},300);

		// Make the off button invisible to turn on highlight. Then hide.
		newButtonImage.stop().animate({'opacity':'0'},300, function(){
			newButtonImage.hide();
		});
	}
	function isEmpty( element ){
		return !$.trim( element.html() );
	}
	function loadPage(pageUrl, pagePath) {
		if (isPageLoading) { return; }
		console.log('loadPage: ', pageUrl, pagePath); // undefined. if only pageUrl.

		pagePath = pagePath || pageUrl;

		var pageDiv = pathParser(pagePath, 'divId');
		if (pageDiv === visiblePage) { return; }
		console.log(pagePath, pageDiv);

		var ajaxArray = pathParser(pagePath, 'array');
		var folder = ajaxArray[0];
		var page = ajaxArray[1];
		console.log('loadPage2: ', folder, page);
		showLoadingAnimation();
		if (isEmpty(jQuery('#'+pageDiv))) {
			// Fetch new page.
			jQuery.ajax({
				type: 'POST',
				url: ajaxurl,
				data: {action: 'getAjaxData', folder: folder, page: page },
				success: function(pageContent) {
					displayPage(pageDiv, pageUrl, pageContent);
				},
				error: function(request, status, error) {
					alert(status, error);
					hideLoadingAnimation();
				}
			});
		} else {
			// Show cached page.
			displayPage(pageDiv, pageUrl);
		}
	}
	function trackPage(pageUrl, pageTitle) {
		pageUrl = pageUrl || document.location.href;
		pageTitle = pageTitle || window.document.title;
		_paq.push(['setCustomUrl', pageUrl]);
		_paq.push(['setDocumentTitle', pageTitle]);
		_paq.push(['setReferrerUrl', pageReferrerUrl]);
		_paq.push(['trackPageView']);
	}
	function trackAction(pageName, slideNumber) {
		// trackEvent(category, action, [name], [value])
		pageName = jQuery('#'+pageName).data('pageTitle');
		slideNumber = 'Slide '+slideNumber;
		_paq.push(['trackEvent', 'Slides', pageName, slideNumber]);
	}
	function updateCategory(pageDiv) {
		var categoryInfo = pageDiv.split('_');
		if (categoryInfo[1] === 'category') {
			window.categoryId = categoryInfo[2];
			window.categoryName = categoryInfo[1];
		} else {
			window.categoryName = categoryInfo[1];
		}
		console.log('updateCategory categoryId: ', window.categoryId, 'categoryName: ', window.categoryName);
	}
	function updateTitle(pageTitle) {
		var pageSeperator = ' â€º ';
		title = siteName;
		if (window.categoryName.length > 0) {
			if (window.categoryName === 'post') {
				window.categoryName = 'blog';
			}
			if(pageTitle.toLowerCase() !== window.categoryName.toLowerCase()){
				title += pageSeperator+window.categoryName.capitalize();
			}
		}
		title += pageSeperator+pageTitle;
		window.document.title = title;
	}
	function updateUrl(pageUrl) {
		pageReferrerUrl = document.location.href;
		history.pushState(null, null, pageUrl);
		trackPage();
	}
	function pathParser(url, returnBack) {
		// The element allows us to access the location object.
		var element = document.createElement('a');
		element.href = url;
		// Now we can use the location object to parse the pathname.
		url = element.pathname;
		// Split the pathname.
		url = url.split(/[\\/]/);
		// Remove empty array elements.
		url = jQuery.grep(url, function(element) { return(element); });

		if (returnBack === 'divId') {
			var divId = 'page_';
			var index = 0;
			var seperator = '';
			url.forEach(function(entry) {
				if (index > 0) { seperator = '_'; }
				divId += seperator+entry;
				++index;
			});
			// If there is no pathname.
			if (divId === 'page_') {
				// Show this div for homepage.
				divId = homepageDiv;
			}
			return divId;
		} else if (returnBack === 'array') {
			// If there is no folder detected.
			if (typeof url[1] === 'undefined') {
				// Add index as the folder for AJAX to process.
				url.unshift('index');
			}
			return url;
		}
	}

	// First page load.
	jQuery('html').animate({'opacity':'1'},500, function() {
		jQuery('#content_wrapper').delay(750).animate({'opacity':'1'},1000);
	});
	window.onload = function() {
		jQuery('#navigation_wrapper').animate({'opacity':'1'},1000);
		hideLoadingAnimation();
	};
	addHighlightSlideCursor();

	// Back and forward navigation event handlers.
	window.addEventListener('popstate', function() {
		var pageUrl = document.location.pathname;
		loadPage(pageUrl);
	});

	// Mouse over effects for the navigation.
	jQuery('nav img.off').hover(
		function() {
			jQuery(this).stop().animate({'opacity': '0'},250); },
		function() {
			jQuery(this).stop().animate({'opacity': '1'},250);
	});

	// Link click event handlers for pages, posts, categories, and outlinks.
	jQuery(document).on('click', 'a', function(event){
		function internalLink() {
			event.preventDefault();
			event.stopPropagation();
		}
		var pagePath; var link = jQuery(this);
		var postId = link.data('postId');
		var postType = link.data('postType');
		var pageUrl = link.attr('href');
		var projectType = link.data('projectType');
		var categoryId = link.data('categoryId');

		// Link click event handler for posts and categories.
		if (postType) {
			internalLink();
			var theId = postId || categoryId;
			pagePath = '/'+postType+'/'+theId;
			loadPage(pageUrl, pagePath);
		// Link click event handler for projectType links on work index page.
		} else if (projectType) {
			internalLink();
			if (!isThumbnailLoading && projectType !== currentProjectType) {
				isThumbnailLoading = true;
				$('#page_work .row').fadeOut(1000, function() {
					$('#page_work .column').hide();
					$('#page_work .column[data-project-type~="'+projectType+'"]').show();
					$('#page_work .row').fadeIn(1000, function() {
						currentProjectType = projectType;
						isThumbnailLoading = false;
					});
				});
			}
		// Link click event handler for outlinks.
		} else if (link.is('.piwik_link')) {
			// Default behavior.
		// Link click event handler for pages.
		} else {
			internalLink();
			loadPage(pageUrl);
		}
	});

	// Link click event handlers for slide navigation.
	jQuery(document).on('click', '#content_wrapper div .numbers_wrapper .numbers div', function(){
		var button = jQuery(this);
		var pageId = button.parent().parent().parent().attr('id');
		var newSlide = button.data('slide');
		var oldSlide = jQuery('#'+pageId+' .highlight_slides > div:visible').data('slide');
		if (oldSlide !== newSlide && !isSlideLoading) {
			isSlideLoading = true;
			transitionSlide(pageId, oldSlide, newSlide);
		}
	});
	jQuery(document).on('click', '#content_wrapper div .highlight_slides div img.highlight', function(){
		var slide = jQuery(this).parent();
		var pageId = slide.parent().parent().attr('id');
		var oldSlide = slide.data('slide');
		var totalDivs = slide.parent().children().length;
		if (totalDivs > 1 && !isSlideLoading) {
			isSlideLoading = true;
			var nextDiv = slide.next('div');
			var newSlide;
			if (nextDiv.length === 0) {
				nextDiv = slide.prevAll('div').last();
				newSlide = nextDiv.data('slide');
			} else {
				newSlide = nextDiv.data('slide');
			}
			transitionSlide(pageId, oldSlide, newSlide);
		}
	});

	/**
	 * Infinite scrolling.
	 *
	 * areAllPostsLoaded resets with function updateVisiblePage.
	 * uses isPageLoading.
	 */
	var categoryId, offsetPosts, areAllPostsLoaded, windowHeight, scrollPosition;
	categoryId = window.categoryId;

	jQuery(window).scroll(function() {
		windowHeight = jQuery(document).height() - jQuery(window).height();
		scrollPosition = jQuery(window).scrollTop() + 200;

		if (scrollPosition >= windowHeight && !areAllPostsLoaded && !isPageLoading) {
			if (jQuery('#page_category_'+categoryId).is(':visible')) {
				showLoadingAnimation();
				offsetPosts = jQuery('#page_category_'+categoryId+' > article').length;
				jQuery.ajax({
					type: 'POST',
					url: ajaxurl,
					data: {action: 'getAjaxData', category: categoryId, offset: offsetPosts },
					success: function(response) {
						if (response === '') {
							areAllPostsLoaded = true;
						} else {
							jQuery('#page_category_'+categoryId+':last-child').append(response);
						}
					},
					error: function(request, status, error){
						alert(status, error);
					},
					complete: function() {
						hideLoadingAnimation();
					}
				});

			} else if (jQuery('#page_blog').is(':visible')) {
				showLoadingAnimation();
				offsetPosts = jQuery('#page_blog > article').length;
				jQuery.ajax({
					type: 'POST',
					url: ajaxurl,
					data: {action: 'getAjaxData', category: '', offset: offsetPosts },
					success: function(response) {
						if (response === '') {
							areAllPostsLoaded = true;
						} else {
							jQuery('#page_blog:last-child').append(response);
						}
					},
					error: function(request, status, error){
						alert(status, error);
					},
					complete: function() {
						hideLoadingAnimation();
					}
				});
			}
		}
	});
});
